<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/css/responsive.css">
        <title>Buy Data - DataSell</title>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <style>
    :root {
        --primary-color: #6c63ff;
        --secondary-color: #ff6584;
        --light-bg: #f8f9fa;
        --card-radius: 12px;
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
    }

    body {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding-bottom: 80px;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    }

    .app-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .app-title {
        </head>
        <body class="mobile-layout">
            <!-- Header -->
            <header class="app-header">
                <div class="container">
                    <div class="d-flex justify-content-between align-items-center py-3">
                        <a href="/" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <h1 class="app-title">Buy Data</h1>
                        <div class="user-avatar" id="userAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="app-main">
                <div class="container">
                    <!-- Selected Network -->
                    <div class="selected-network mb-3">
                        <div class="network-badge" id="selectedNetwork">
                            <i class="fas fa-wifi"></i>
                            <span id="networkName">Selecting Network...</span>
                        </div>
                    </div>

                    <!-- Wallet Info -->
                    <div class="wallet-info">
                        <p class="wallet-label">Available Balance</p>
                        <p class="wallet-balance" id="walletBalance">
                            <span class="loading-spinner" id="balanceLoading"></span>
                            <span id="balanceText" style="display: none;">â‚µ0.00</span>
                        </p>
                    </div>

                    <!-- Data Packages Grid -->
                    <div class="packages-section mb-4">
                        <h2 class="section-title">Select Data Package</h2>
                        <div id="packagesList" class="packages-grid">
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                                <div class="loading-spinner" style="margin: 0 auto;"></div>
                                <p class="mt-2 text-muted">Loading packages...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <a href="/" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="/wallet" class="nav-item">
                    <i class="fas fa-wallet"></i>
                    <span>Wallet</span>
                </a>
                <a href="/orders" class="nav-item">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Orders</span>
                </a>
                <a href="/profile" class="nav-item">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
            </nav>

            <!-- Phone Number Modal -->
            <div class="modal fade" id="phoneModal" tabindex="-1" aria-labelledby="phoneModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="phoneModalLabel">
                                <i class="fas fa-phone me-2" style="color: var(--primary-color);"></i>Complete Purchase
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Package Preview -->
                            <div id="packagePreview" style="background: rgba(108, 99, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem;">Selected Package</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #333;" id="previewPackage">1GB</div>
                                <div style="font-size: 0.9rem; color: var(--primary-color); font-weight: 600; margin-top: 0.25rem;" id="previewPrice">â‚µ5.99</div>
                            </div>

                            <!-- Compact modal -- receiver preview removed per request -->

                                <!-- Payment Method Selection -->
                            <form id="phoneForm">
                                <div style="margin-bottom: 1.5rem;">
                                    <label class="form-label" style="font-weight: 700; margin-bottom: 0.75rem; font-size: 0.95rem;">Payment Method</label>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                        <div class="payment-option-modal selected" onclick="selectPaymentMethodModal('wallet')">
                                            <input type="radio" class="btn-check" name="paymentMethod" id="walletRadio" value="wallet" checked style="display: none;">
                                            <i class="fas fa-wallet"></i>
                                            <div style="font-weight: 600; color: #333; font-size: 0.85rem;">Wallet</div>
                                        </div>
                                        <div class="payment-option-modal" onclick="selectPaymentMethodModal('direct')">
                                            <input type="radio" class="btn-check" name="paymentMethod" id="directRadio" value="direct" style="display: none;">
                                            <i class="fas fa-credit-card"></i>
                                            <div style="font-weight: 600; color: #333; font-size: 0.85rem;">Direct Pay</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Phone Number Input -->
                                <div class="mb-3">
                                    <label for="modalPhoneNumber" class="form-label" style="font-weight: 600;">Receiver's Number</label>
                                    <input type="tel" class="form-control" id="modalPhoneNumber" placeholder="0241234567" pattern="[0-9]{10}" maxlength="10" required>
                                    <small class="form-text">Enter 10-digit Ghana number (e.g., 0241234567)</small>
                                </div>

                                <!-- Purchase Button -->
                                <button type="submit" class="btn purchase-btn w-100">
                                    <span id="confirmBtnText">Confirm Purchase</span>
                                    <span id="confirmBtnLoading" class="loading-spinner" style="display: none; margin-left: 8px;"></span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Success Modal -->
            <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content" style="border: none; border-radius: 12px; overflow: hidden; background: white;">
                        <div style="background: white; padding: 1.25rem 1.5rem 0.75rem 1.5rem; text-align: center; border-bottom: 1px solid #e9ecef;">
                            <div id="resultIconWrap" style="width: 72px; height: 72px; background: white; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.05);">
                                <i id="resultIcon" class="fas fa-check" style="font-size: 2rem; color: var(--primary-color);"></i>
                            </div>
                            <h4 id="resultTitle" style="color: #111827; margin: 0; font-weight: 700; font-size: 1.1rem;">Package Sent!</h4>
                            <p id="resultSubtitle" style="color: #6b7280; margin: 0.35rem 0 0 0; font-size: 0.9rem;">Your data is being delivered</p>
                        </div>
                        <div class="modal-body" style="padding: 1.25rem;">
                            <!-- From Section -->
                            <div style="margin-bottom: 0.9rem;">
                                <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 0.35rem; text-transform: uppercase; font-weight: 600;">From</div>
                                <div style="background: white; padding: 0.6rem 0.9rem; border-radius: 8px; border: 1px solid #e9ecef;">
                                    <div style="font-size: 0.95rem; color: #333; font-weight: 600;" id="successUserNumber">+233 XXX XXX</div>
                                </div>
                            </div>
                            <!-- To Section -->
                            <div style="margin-bottom: 0.9rem;">
                                <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 0.35rem; text-transform: uppercase; font-weight: 600;">To (Receiver)</div>
                                <div style="background: white; padding: 0.6rem 0.9rem; border-radius: 8px; border: 1px solid #e9ecef;">
                                    <div style="font-size: 0.95rem; color: #333; font-weight: 600;" id="successReceiverNumber">0241234567</div>
                                </div>
                            </div>
                            <!-- Package Details -->
                            <div style="margin-bottom: 0.9rem;">
                                <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 0.35rem; text-transform: uppercase; font-weight: 600;">Package</div>
                                <div style="background: white; padding: 0.8rem; border-radius: 8px; border: 1px solid #e9ecef;">
                                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.35rem;">Data Package</div>
                                    <div style="font-size: 1.05rem; font-weight: 700; color: #333;" id="successPackage">1GB - â‚µ5.99</div>
                                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.35rem;" id="successNetwork">MTN Network</div>
                                </div>
                            </div>
                            <!-- Order ID -->
                            <div style="margin-bottom: 0.9rem;">
                                <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 0.35rem; text-transform: uppercase; font-weight: 600;">Order ID</div>
                                <div style="background: white; padding: 0.6rem 0.9rem; border-radius: 8px; font-family: 'Courier New', monospace; display: flex; align-items: center; justify-content: space-between; border:1px solid #e9ecef;">
                                    <span style="font-size: 0.9rem; color: #333; font-weight: 600;" id="successOrderId">#12345678</span>
                                    <button type="button" onclick="copyOrderId()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Reference -->
                            <div style="margin-bottom: 0.9rem;">
                                <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 0.35rem; text-transform: uppercase; font-weight: 600;">Reference</div>
                                <div style="background: white; padding: 0.6rem 0.9rem; border-radius: 8px; font-family: 'Courier New', monospace; border:1px solid #e9ecef;">
                                    <span id="successReference" style="font-size:0.9rem;color:#333;font-weight:600;">-</span>
                                </div>
                            </div>
                            <!-- Action Button -->
                            <button id="resultPrimaryBtn" type="button" class="btn btn-primary" style="width: 100%; color: white; border: none; padding: 0.65rem; border-radius: 8px; font-weight: 600; margin-top: 0.5rem; min-height: 44px;">
                                <i class="fas fa-home me-2"></i>Back to Home
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
            <script>
                // Initialize Notyf
                const notyf = new Notyf({
                    duration: 4000,
                    position: { x: 'center', y: 'top' }
                });

                let currentUser = null;
                let userBalance = 0;
                let selectedNetwork = null;
                let selectedPackage = null;
                let selectedPaymentMethod = 'wallet';
                let packages = [];
                let phoneModal = null;
                let successModal = null;

                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const networkParam = urlParams.get('network');
                const verifyParam = urlParams.get('verify');
                const referenceParam = urlParams.get('reference');

                // Initialize app
                async function initializeApp() {
                    try {
                        // Check authentication
                        const userResponse = await fetch('/api/user');
                        const userResult = await userResponse.json();
                
                        if (userResult.success && userResult.user) {
                            currentUser = userResult.user;
                            updateUserAvatar();
                            await loadWalletBalance();
                    
                            // Check if returning from Paystack payment
                            if (verifyParam === 'true' && referenceParam) {
                                console.log('ðŸ”„ Verifying payment...');
                                await verifyDirectPayment(referenceParam);
                            } else {
                                await initializeNetwork();
                                await loadPackages();
                                setupEventListeners();
                        
                                // Initialize modal
                                phoneModal = new bootstrap.Modal(document.getElementById('phoneModal'));
                                successModal = new bootstrap.Modal(document.getElementById('successModal'));
                            }
                        } else {
                            window.location.href = '/login';
                        }
                    } catch (error) {
                        console.error('Initialization error:', error);
                        window.location.href = '/login';
                    }
                }

                // Update user avatar
                function updateUserAvatar() {
                    if (currentUser && currentUser.displayName) {
                        const names = currentUser.displayName.split(' ');
                        const initials = names.map(name => name[0]).join('').toUpperCase();
                        document.getElementById('userAvatar').textContent = initials;
                    }
                }

                // Load wallet balance
                async function loadWalletBalance() {
                    try {
                        const response = await fetch('/api/wallet/balance');
                        const result = await response.json();
                
                        if (result.success) {
                            userBalance = result.balance;
                            document.getElementById('balanceText').textContent = `â‚µ${userBalance.toFixed(2)}`;
                            document.getElementById('balanceLoading').style.display = 'none';
                            document.getElementById('balanceText').style.display = 'inline';
                        }
                    } catch (error) {
                        console.error('Failed to load wallet balance:', error);
                        document.getElementById('balanceText').textContent = 'â‚µ0.00';
                        document.getElementById('balanceLoading').style.display = 'none';
                        document.getElementById('balanceText').style.display = 'inline';
                    }
                }

                // Initialize network selection
                function initializeNetwork() {
                    if (networkParam && ['mtn', 'at'].includes(networkParam)) {
                        selectedNetwork = networkParam;
                        const networkName = networkParam === 'mtn' ? 'MTN' : 'AirtelTigo';
                        document.getElementById('networkName').textContent = networkName;
                    } else {
                        // Default to MTN if no valid network in URL
                        selectedNetwork = 'mtn';
                        document.getElementById('networkName').textContent = 'MTN';
                    }
                }

                // Load data packages
                async function loadPackages() {
                    try {
                        const response = await fetch(`/api/packages/${selectedNetwork}`);
                        const result = await response.json();
                
                        if (result.success) {
                            packages = result.packages;
                            displayPackages();
                        } else {
                            throw new Error('Failed to load packages');
                        }
                    } catch (error) {
                        console.error('Package loading error:', error);
                        document.getElementById('packagesList').innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2" style="display: block;"></i>
                                <p class="text-muted">Failed to load packages. Please try again.</p>
                                <button class="btn btn-sm btn-primary" onclick="loadPackages()">
                                    <i class="fas fa-redo me-1"></i>Retry
                                </button>
                            </div>
                        `;
                    }
                }

                // Display packages in grid
                function displayPackages() {
                    const packagesList = document.getElementById('packagesList');
            
                    if (packages.length === 0) {
                        packagesList.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                                <i class="fas fa-box-open fa-2x text-muted mb-2" style="display: block;"></i>
                                <p class="text-muted">No packages available for this network.</p>
                            </div>
                        `;
                        return;
                    }

                    // Sort packages by volume
                    const sortedPackages = [...packages].sort((a, b) => {
                        const getVolume = (pkg) => {
                            if (pkg.name) {
                                const volumeMatch = pkg.name.match(/\d+/);
                                return volumeMatch ? parseInt(volumeMatch[0]) : 0;
                            }
                            return 0;
                        };
                        return getVolume(a) - getVolume(b);
                    });

                    packagesList.innerHTML = sortedPackages.map(pkg => {
                        // Extract volume from package name
                        let volume = 'â€”';
                        if (pkg.name) {
                            const volumeMatch = pkg.name.match(/(\d+)\s*(GB|MB)?/i);
                            if (volumeMatch) {
                                volume = volumeMatch[1] + (volumeMatch[2] || 'GB');
                            }
                        }

                        // Get network logo
                        const networkLogo = selectedNetwork === 'mtn' ? '/images/mtn-logo.png' : '/images/airteltigo-logo.png';
                        const networkLabel = selectedNetwork === 'mtn' ? 'MTN' : 'AT';

                        return `
                        <div class="package-card" onclick="openPhoneModal('${pkg.id}', '${pkg.name}', ${pkg.price})">
                            <div class="network-badge-small">
                                <img src="${networkLogo}" alt="${networkLabel}" />
                                <span>${networkLabel}</span>
                            </div>
                            <div class="package-gb">${volume}</div>
                            <div class="package-price">â‚µ${pkg.price.toFixed(2)}</div>
                            <div class="package-validity">${pkg.validity || '30 days'}</div>
                        </div>
                        `;
                    }).join('');
                }

                // Open phone modal when package is clicked
                function openPhoneModal(packageId, packageName, price) {
                    // Find the package
                    selectedPackage = packages.find(pkg => pkg.id === packageId);
            
                    if (!selectedPackage) {
                        console.error('Package not found:', packageId);
                        return;
                    }

                    // Update preview
                    document.getElementById('previewPackage').textContent = packageName;
                    document.getElementById('previewPrice').textContent = `â‚µ${price.toFixed(2)}`;

                    // Reset phone input
                    document.getElementById('modalPhoneNumber').value = '';
                    document.getElementById('phoneForm').reset();
                    document.getElementById('walletRadio').checked = true;
                    selectedPaymentMethod = 'wallet';

                    // Show modal
                    phoneModal.show();

                    // Focus on phone input
                    setTimeout(() => {
                        document.getElementById('modalPhoneNumber').focus();
                    }, 100);
                }

                // Verify direct payment from Paystack callback
                async function verifyDirectPayment(reference) {
                    try {
                        console.log('ðŸ” Verifying payment with reference:', reference);
                
                        const response = await fetch(`/api/verify-direct-payment/${reference}`);
                        const result = await response.json();

                        console.log('âœ… Payment verification result:', result);

                        if (result.success) {
                            // show result modal with any available details
                            showResultModal({
                                status: 'success',
                                orderId: result.orderId || (result.data && result.data.orderId),
                                reference: result.reference || (result.data && result.data.reference) || reference,
                                phoneNumber: result.phoneNumber || (result.data && result.data.phoneNumber),
                                packageName: result.packageName || (selectedPackage && selectedPackage.name),
                                packagePrice: result.packagePrice || (selectedPackage && selectedPackage.price),
                                network: selectedNetwork,
                                userPhone: currentUser && currentUser.phoneNumber ? currentUser.phoneNumber : ''
                            });
                        } else {
                            // show failure modal with reason
                            const msg = result.error || (result.isOutOfStock ? 'Out of Stock - Provider has insufficient balance' : 'Payment verification failed');
                            showResultModal({ status: 'failed', message: msg, orderId: result.orderId });
                        }
                    } catch (error) {
                        console.error('Payment verification error:', error);
                        notyf.error('Payment verification error: ' + error.message);
                
                        setTimeout(() => {
                            window.location.href = '/purchase';
                        }, 3000);
                    }
                }

                // Setup event listeners
                function setupEventListeners() {
                    // Handle phone form submission
                    document.getElementById('phoneForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                
                        const phoneNumber = document.getElementById('modalPhoneNumber').value;
                        const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
                        selectedPaymentMethod = selectedRadio ? selectedRadio.value : 'wallet';

                        // Validate phone
                        if (!/^\d{10}$/.test(phoneNumber)) {
                            notyf.error('Please enter a valid 10-digit phone number');
                            return;
                        }

                        // Process purchase
                        if (selectedPaymentMethod === 'wallet') {
                            await purchaseWithWallet(phoneNumber);
                        } else {
                            await purchaseWithDirectPayment(phoneNumber);
                        }
                    });

                    // Handle payment method radio changes in modal
                    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            selectedPaymentMethod = e.target.value;
                        });
                    });
                }

                // Purchase with wallet
                async function purchaseWithWallet(phoneNumber) {
                    if (!selectedPackage || !currentUser) return;

                    const confirmBtn = document.querySelector('#phoneForm button[type="submit"]');
                    const confirmBtnText = document.getElementById('confirmBtnText');
                    const confirmBtnLoading = document.getElementById('confirmBtnLoading');

                    // Check balance
                    if (userBalance < selectedPackage.price) {
                        notyf.error('Insufficient balance. Please fund your wallet.');
                        phoneModal.hide();
                        window.location.href = '/wallet';
                        return;
                    }

                    // Show loading
                    confirmBtn.disabled = true;
                    confirmBtnText.textContent = 'Processing...';
                    confirmBtnLoading.style.display = 'inline-block';

                    try {
                        // Extract volume from package name
                        let volume = '1';
                        if (selectedPackage.name) {
                            const volumeMatch = selectedPackage.name.match(/\d+/);
                            if (volumeMatch) {
                                volume = volumeMatch[0];
                            }
                        }

                        const response = await fetch('/api/purchase-data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                network: selectedNetwork,
                                volume: volume,
                                phoneNumber: phoneNumber,
                                amount: selectedPackage.price,
                                packageName: selectedPackage.name
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            console.log('âœ… Purchase successful:', result);
                    
                            // Update balance
                            userBalance = result.newBalance;
                            document.getElementById('balanceText').textContent = `â‚µ${userBalance.toFixed(2)}`;
                    
                            // Close phone modal
                            phoneModal.hide();
                    
                            // Show success modal with order details
                            showResultModal({
                                status: 'success',
                                orderId: result.orderId,
                                reference: result.reference || result.ref || result.transactionReference,
                                phoneNumber: phoneNumber,
                                packageName: selectedPackage.name,
                                packagePrice: selectedPackage.price,
                                network: selectedNetwork,
                                userPhone: currentUser && currentUser.phoneNumber ? currentUser.phoneNumber : ''
                            });
                        } else {
                            // Check if it's an out of stock error
                            const msg = result.error || (result.isOutOfStock ? 'Out of Stock - Provider has insufficient balance' : 'Purchase failed');
                            console.log('ðŸ“¦ Purchase failed:', msg);
                            showResultModal({ status: 'failed', message: msg, orderId: result.orderId });

                            // Reset button
                            confirmBtn.disabled = false;
                            confirmBtnText.textContent = 'Confirm Purchase';
                            confirmBtnLoading.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Purchase error:', error);
                        notyf.error(error.message);
                
                        // Reset button
                        confirmBtn.disabled = false;
                        confirmBtnText.textContent = 'Confirm Purchase';
                        confirmBtnLoading.style.display = 'none';
                    }
                }

                // Purchase with direct payment
                async function purchaseWithDirectPayment(phoneNumber) {
                    if (!selectedPackage || !currentUser) return;

                    const confirmBtn = document.querySelector('#phoneForm button[type="submit"]');
                    const confirmBtnText = document.getElementById('confirmBtnText');
                    const confirmBtnLoading = document.getElementById('confirmBtnLoading');

                    // Show loading
                    confirmBtn.disabled = true;
                    confirmBtnText.textContent = 'Initializing Payment...';
                    confirmBtnLoading.style.display = 'inline-block';

                    try {
                        console.log('ðŸ”„ Initializing direct payment for:', {
                            amount: selectedPackage.price,
                            phoneNumber: phoneNumber,
                            network: selectedNetwork,
                            package: selectedPackage.name
                        });

                        // Extract volume from package name
                        let volume = '1';
                        if (selectedPackage.name) {
                            const volumeMatch = selectedPackage.name.match(/\d+/);
                            if (volumeMatch) {
                                volume = volumeMatch[0];
                            }
                        }

                        // Initialize direct payment
                        const response = await fetch('/api/initialize-direct-payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                amount: selectedPackage.price,
                                phoneNumber: phoneNumber,
                                network: selectedNetwork,
                                packageName: selectedPackage.name,
                                volume: volume
                            })
                        });

                        const result = await response.json();

                        console.log('ðŸ’° Server response:', result);

                        if (result.status && result.data && result.data.authorization_url) {
                            console.log('âœ… Redirecting to Paystack...');
                            // Redirect to Paystack
                            window.location.href = result.data.authorization_url;
                        } else if (response.ok) {
                            throw new Error(result.error || result.message || 'Failed to initialize payment');
                        } else {
                            throw new Error(result.error || result.message || 'Server error');
                        }
                    } catch (error) {
                        console.error('Direct payment error:', error);

                        const msg = (error && error.message && error.message.includes('Out of Stock')) ? 'Out of Stock - Data temporarily unavailable. Please try again later.' : (`Payment failed: ${error && error.message ? error.message : 'An error occurred'}`);
                        showResultModal({ status: 'failed', message: msg });

                        // Reset button
                        confirmBtn.disabled = false;
                        confirmBtnText.textContent = 'Confirm Purchase';
                        confirmBtnLoading.style.display = 'none';
                    }
                }

                // Show result modal (success or failed) with order details
                function showResultModal(data) {
                    // data: { status: 'success'|'failed', orderId, phoneNumber, packageName, packagePrice, network, userPhone, message }
                    const formatPhoneDisplay = (phone) => {
                        if (!phone) return '-';
                        const cleanPhone = String(phone).replace(/\D/g, '');
                        if (cleanPhone.length === 10) {
                            return `+233 ${cleanPhone.substring(0, 3)} ${cleanPhone.substring(3, 6)} ${cleanPhone.substring(6)}`;
                        }
                        return `+233 ${cleanPhone}`;
                    };

                    const status = data.status || (data.orderId ? 'success' : 'failed');
                    const networkLabel = data.network === 'mtn' ? 'MTN' : data.network === 'at' ? 'AT' : (data.network || 'Network');

                    // Update numbers and package info if present
                    if (document.getElementById('successUserNumber')) document.getElementById('successUserNumber').textContent = formatPhoneDisplay(data.userPhone);
                    if (document.getElementById('successReceiverNumber')) document.getElementById('successReceiverNumber').textContent = formatPhoneDisplay(data.phoneNumber);
                    if (document.getElementById('successPackage')) document.getElementById('successPackage').textContent = data.packageName ? `${data.packageName} - â‚µ${(data.packagePrice||0).toFixed(2)}` : (data.packageName || '');
                    if (document.getElementById('successNetwork')) document.getElementById('successNetwork').textContent = `${networkLabel} Network`;
                    if (document.getElementById('successOrderId')) document.getElementById('successOrderId').textContent = data.orderId ? `#${data.orderId}` : '';

                    // Header / icon / subtitle
                    const icon = document.getElementById('resultIcon');
                    const iconWrap = document.getElementById('resultIconWrap');
                    const title = document.getElementById('resultTitle');
                    const subtitle = document.getElementById('resultSubtitle');
                    const primaryBtn = document.getElementById('resultPrimaryBtn');

                    if (status === 'success') {
                        if (icon) { icon.className = 'fas fa-check'; icon.style.color = '#ffffff'; }
                        if (iconWrap) { iconWrap.style.background = '#2f855a'; }
                        if (title) title.textContent = 'Package Sent!';
                        if (subtitle) subtitle.textContent = 'Your data is being delivered';
                        if (primaryBtn) {
                            primaryBtn.textContent = '';
                            primaryBtn.innerHTML = '<i class="fas fa-home me-2"></i>Back to Home';
                            primaryBtn.onclick = () => { if (successModal) successModal.hide(); setTimeout(()=>window.location.href='/',300); };
                        }
                    } else {
                        // failed
                        if (icon) { icon.className = 'fas fa-times-circle'; icon.style.color = '#ffffff'; }
                        if (iconWrap) { iconWrap.style.background = '#e53e3e'; }
                        if (title) title.textContent = 'Purchase Failed';
                        if (subtitle) subtitle.textContent = data.message || 'We could not process your purchase.';
                        if (primaryBtn) {
                            primaryBtn.textContent = '';
                            primaryBtn.innerHTML = '<i class="fas fa-arrow-left me-2"></i>Back to Purchase';
                            primaryBtn.onclick = () => { if (successModal) successModal.hide(); setTimeout(()=>window.location.href='/purchase',300); };
                        }
                    }

                    // expose last order id for copy
                    window.currentOrderId = data.orderId || window.currentOrderId;

                    // Reference (transaction reference) if provided
                    if (document.getElementById('successReference')) {
                        const ref = data.reference || data.ref || data.transactionReference || '';
                        document.getElementById('successReference').textContent = ref || '-';
                    }

                    if (successModal) successModal.show();
                }

                // Copy order ID to clipboard
                function copyOrderId() {
                    const orderId = document.getElementById('successOrderId').textContent;
                    navigator.clipboard.writeText(orderId).then(() => {
                        notyf.success('Order ID copied!');
                    }).catch(() => {
                        notyf.error('Failed to copy');
                    });
                }

                // Go back to home
                function goToHome() {
                    if (successModal) {
                        successModal.hide();
                    }
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 300);
                }

                // Select payment method from payment options (if needed for compatibility)
                function selectPaymentMethod(method) {
                    selectedPaymentMethod = method;
            
                    // Update UI
                    document.querySelectorAll('.payment-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    event.target.closest('.payment-option').classList.add('selected');
                }

                // Select payment method from modal
                function selectPaymentMethodModal(method) {
                    selectedPaymentMethod = method;
            
                    // Update radio button
                    if (method === 'wallet') {
                        document.getElementById('walletRadio').checked = true;
                    } else {
                        document.getElementById('directRadio').checked = true;
                    }
            
                    // Update UI
                    document.querySelectorAll('.payment-option-modal').forEach(option => {
                        option.classList.remove('selected');
                    });
                    event.currentTarget.classList.add('selected');
                }

                // Initialize app when page loads
                document.addEventListener('DOMContentLoaded', initializeApp);
            </script>
        </body>
        </html>
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="phoneModalLabel">
                        <i class="fas fa-phone me-2" style="color: var(--primary-color);"></i>Complete Purchase
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Package Preview -->
                    <div id="packagePreview" style="background: rgba(108, 99, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem;">Selected Package</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: #333;" id="previewPackage">1GB</div>
                        <div style="font-size: 0.9rem; color: var(--primary-color); font-weight: 600; margin-top: 0.25rem;" id="previewPrice">â‚µ5.99</div>
                    </div>

                        <!-- Payment Method Selection -->
                    <form id="phoneForm">
                        <div style="margin-bottom: 1.5rem;">
                            <label class="form-label" style="font-weight: 700; margin-bottom: 0.75rem; font-size: 0.95rem;">Payment Method</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div class="payment-option-modal selected" onclick="selectPaymentMethodModal('wallet')">
                                    <input type="radio" class="btn-check" name="paymentMethod" id="walletRadio" value="wallet" checked style="display: none;">
                                    <i class="fas fa-wallet"></i>
                                    <div style="font-weight: 600; color: #333; font-size: 0.85rem;">Wallet</div>
                                </div>
                                <div class="payment-option-modal" onclick="selectPaymentMethodModal('direct')">
                                    <input type="radio" class="btn-check" name="paymentMethod" id="directRadio" value="direct" style="display: none;">
                                    <i class="fas fa-credit-card"></i>
                                    <div style="font-weight: 600; color: #333; font-size: 0.85rem;">Direct Pay</div>
                                </div>
                            </div>
                        </div>

                        <!-- Phone Number Input -->
                        <div class="mb-3">
                            <label for="modalPhoneNumber" class="form-label" style="font-weight: 600;">Receiver's Number</label>
                            <input type="tel" class="form-control" id="modalPhoneNumber" placeholder="0241234567" pattern="[0-9]{10}" maxlength="10" required>
                            <small class="form-text">Enter 10-digit Ghana number (e.g., 0241234567)</small>
                        </div>

                        <!-- Purchase Button -->
                        <button type="submit" class="btn purchase-btn w-100">
                            <span id="confirmBtnText">Confirm Purchase</span>
                            <span id="confirmBtnLoading" class="loading-spinner" style="display: none; margin-left: 8px;"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal (copied from public implementation) -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden; background: white;">
                        <div style="background: white; padding: 1.25rem 2rem 0.75rem 2rem; text-align: center; border-bottom: 1px solid #eef2ff;">
                            <div id="resultIconWrap" style="width: 80px; height: 80px; background: #e6f4ea; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                                <i id="resultIcon" class="fas fa-check" style="font-size: 2.25rem; color: #2f855a;"></i>
                            </div>
                            <h4 id="resultTitle" style="color: #111827; margin: 0; font-weight: 700; font-size: 1.25rem;">Package Sent!</h4>
                            <p id="resultSubtitle" style="color: #6b7280; margin: 0.35rem 0 0 0; font-size: 0.95rem;">Your data is being delivered</p>
                        </div>
                <div class="modal-body" style="padding: 2rem;">
                    <!-- From Section -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">From</div>
                        <div style="background: #f8f9fa; padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #6c63ff;">
                            <div style="font-size: 0.95rem; color: #333; font-weight: 600;" id="successUserNumber">+233 XXX XXX</div>
                        </div>
                    </div>
                    <!-- To Section -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">To (Receiver)</div>
                        <div style="background: #f8f9fa; padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #4caf50;">
                            <div style="font-size: 0.95rem; color: #333; font-weight: 600;" id="successReceiverNumber">0241234567</div>
                        </div>
                    </div>
                    <!-- Package Details -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Package</div>
                        <div style="background: rgba(108, 99, 255, 0.05); padding: 1rem; border-radius: 8px; border: 1px solid rgba(108, 99, 255, 0.2);">
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Data Package</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #333;" id="successPackage">1GB - â‚µ5.99</div>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;" id="successNetwork">MTN Network</div>
                        </div>
                    </div>
                    <!-- Order ID -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Order ID</div>
                        <div style="background: #f8f9fa; padding: 0.75rem 1rem; border-radius: 8px; font-family: 'Courier New', monospace; display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 0.9rem; color: #333; font-weight: 600;" id="successOrderId">#12345678</span>
                            <button type="button" onclick="copyOrderId()" style="background: none; border: none; color: #6c63ff; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                        <!-- Reference -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 600;">Reference</div>
                            <div style="background: #f8f9fa; padding: 0.75rem 1rem; border-radius: 8px; font-family: 'Courier New', monospace;">
                                <span id="successReference" style="font-size:0.9rem;color:#333;font-weight:600;">-</span>
                            </div>
                        </div>
                    <!-- Action Button -->
                    <button id="resultPrimaryBtn" type="button" class="btn" style="width: 100%; background: linear-gradient(135deg, #6c63ff 0%, #5a52d5 100%); color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; margin-top: 1rem; min-height: 44px;">
                        <i class="fas fa-home me-2"></i>Back to Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
        // Initialize Notyf
        const notyf = new Notyf({
            duration: 4000,
            position: { x: 'center', y: 'top' }
        });

        let currentUser = null;
        let userBalance = 0;
        let selectedNetwork = null;
        let selectedPackage = null;
        let selectedPaymentMethod = 'wallet';
        let packages = [];
        let phoneModal = null;
        let successModal = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const networkParam = urlParams.get('network');
        const verifyParam = urlParams.get('verify');
        const referenceParam = urlParams.get('reference');

        // Initialize app
        async function initializeApp() {
            try {
                // Check authentication
                const userResponse = await fetch('/api/user');
                const userResult = await userResponse.json();
                
                if (userResult.success && userResult.user) {
                    currentUser = userResult.user;
                    updateUserAvatar();
                    await loadWalletBalance();
                    
                    // Check if returning from Paystack payment
                    if (verifyParam === 'true' && referenceParam) {
                        console.log('ðŸ”„ Verifying payment...');
                        await verifyDirectPayment(referenceParam);
                    } else {
                        await initializeNetwork();
                        await loadPackages();
                        setupEventListeners();
                        
                        // Initialize modal
                        phoneModal = new bootstrap.Modal(document.getElementById('phoneModal'));
                        successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                window.location.href = '/login';
            }
        }

        // Update user avatar
        function updateUserAvatar() {
            if (currentUser && currentUser.displayName) {
                const names = currentUser.displayName.split(' ');
                const initials = names.map(name => name[0]).join('').toUpperCase();
                document.getElementById('userAvatar').textContent = initials;
            }
        }

        // Load wallet balance
        async function loadWalletBalance() {
            try {
                const response = await fetch('/api/wallet/balance');
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.balance;
                    document.getElementById('balanceText').textContent = `â‚µ${userBalance.toFixed(2)}`;
                    document.getElementById('balanceLoading').style.display = 'none';
                    document.getElementById('balanceText').style.display = 'inline';
                }
            } catch (error) {
                console.error('Failed to load wallet balance:', error);
                document.getElementById('balanceText').textContent = 'â‚µ0.00';
                document.getElementById('balanceLoading').style.display = 'none';
                document.getElementById('balanceText').style.display = 'inline';
            }
        }

        // Initialize network selection
        function initializeNetwork() {
            if (networkParam && ['mtn', 'at'].includes(networkParam)) {
                selectedNetwork = networkParam;
                const networkName = networkParam === 'mtn' ? 'MTN' : 'AirtelTigo';
                document.getElementById('networkName').textContent = networkName;
            } else {
                // Default to MTN if no valid network in URL
                selectedNetwork = 'mtn';
                document.getElementById('networkName').textContent = 'MTN';
            }
        }

        // Load data packages
        async function loadPackages() {
            try {
                const response = await fetch(`/api/packages/${selectedNetwork}`);
                const result = await response.json();
                
                if (result.success) {
                    packages = result.packages;
                    displayPackages();
                } else {
                    throw new Error('Failed to load packages');
                }
            } catch (error) {
                console.error('Package loading error:', error);
                document.getElementById('packagesList').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2" style="display: block;"></i>
                        <p class="text-muted">Failed to load packages. Please try again.</p>
                        <button class="btn btn-sm btn-primary" onclick="loadPackages()">
                            <i class="fas fa-redo me-1"></i>Retry
                        </button>
                    </div>
                `;
            }
        }

        // Display packages in grid
        function displayPackages() {
            const packagesList = document.getElementById('packagesList');
            
            if (packages.length === 0) {
                packagesList.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                        <i class="fas fa-box-open fa-2x text-muted mb-2" style="display: block;"></i>
                        <p class="text-muted">No packages available for this network.</p>
                    </div>
                `;
                return;
            }

            // Sort packages by volume
            const sortedPackages = [...packages].sort((a, b) => {
                const getVolume = (pkg) => {
                    if (pkg.name) {
                        const volumeMatch = pkg.name.match(/\d+/);
                        return volumeMatch ? parseInt(volumeMatch[0]) : 0;
                    }
                    return 0;
                };
                return getVolume(a) - getVolume(b);
            });

            packagesList.innerHTML = sortedPackages.map(pkg => {
                // Extract volume from package name
                let volume = 'â€”';
                if (pkg.name) {
                    const volumeMatch = pkg.name.match(/(\d+)\s*(GB|MB)?/i);
                    if (volumeMatch) {
                        volume = volumeMatch[1] + (volumeMatch[2] || 'GB');
                    }
                }

                // Get network logo
                const networkLogo = selectedNetwork === 'mtn' ? '/images/mtn-logo.png' : '/images/airteltigo-logo.png';
                const networkLabel = selectedNetwork === 'mtn' ? 'MTN' : 'AT';

                return `
                <div class="package-card" onclick="openPhoneModal('${pkg.id}', '${pkg.name}', ${pkg.price})">
                    <div class="network-badge-small">
                        <img src="${networkLogo}" alt="${networkLabel}" />
                        <span>${networkLabel}</span>
                    </div>
                    <div class="package-gb">${volume}</div>
                    <div class="package-price">â‚µ${pkg.price.toFixed(2)}</div>
                    <div class="package-validity">${pkg.validity || '30 days'}</div>
                </div>
                `;
            }).join('');
        }

        // Open phone modal when package is clicked
        function openPhoneModal(packageId, packageName, price) {
            // Find the package
            selectedPackage = packages.find(pkg => pkg.id === packageId);
            
            if (!selectedPackage) {
                console.error('Package not found:', packageId);
                return;
            }

            // Update preview
            document.getElementById('previewPackage').textContent = packageName;
            document.getElementById('previewPrice').textContent = `â‚µ${price.toFixed(2)}`;

            // Reset phone input
            document.getElementById('modalPhoneNumber').value = '';
            document.getElementById('phoneForm').reset();
            document.getElementById('walletRadio').checked = true;
            selectedPaymentMethod = 'wallet';

            // Show modal
            phoneModal.show();

            // Focus on phone input
            setTimeout(() => {
                document.getElementById('modalPhoneNumber').focus();
            }, 100);
        }

        // Verify direct payment from Paystack callback
        async function verifyDirectPayment(reference) {
            try {
                console.log('ðŸ” Verifying payment with reference:', reference);
                
                const response = await fetch(`/api/verify-direct-payment/${reference}`);
                const result = await response.json();

                console.log('âœ… Payment verification result:', result);

                if (result.success) {
                    // show result modal with any available details
                    showResultModal({
                        status: 'success',
                        orderId: result.orderId || (result.data && result.data.orderId),
                        reference: result.reference || (result.data && result.data.reference) || reference,
                        phoneNumber: result.phoneNumber || (result.data && result.data.phoneNumber),
                        packageName: result.packageName || (selectedPackage && selectedPackage.name),
                        packagePrice: result.packagePrice || (selectedPackage && selectedPackage.price),
                        network: selectedNetwork,
                        userPhone: currentUser && currentUser.phoneNumber
                    });
                } else {
                    // show failure modal with reason
                    const msg = result.error || (result.isOutOfStock ? 'Out of Stock - Provider has insufficient balance' : 'Payment verification failed');
                    showResultModal({ status: 'failed', message: msg, orderId: result.orderId });
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                notyf.error('Payment verification error: ' + error.message);
                
                setTimeout(() => {
                    window.location.href = '/purchase';
                }, 3000);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Handle phone form submission
            document.getElementById('phoneForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const phoneNumber = document.getElementById('modalPhoneNumber').value;
                const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
                selectedPaymentMethod = selectedRadio ? selectedRadio.value : 'wallet';

                // Validate phone
                if (!/^\d{10}$/.test(phoneNumber)) {
                    notyf.error('Please enter a valid 10-digit phone number');
                    return;
                }

                // Process purchase
                if (selectedPaymentMethod === 'wallet') {
                    await purchaseWithWallet(phoneNumber);
                } else {
                    await purchaseWithDirectPayment(phoneNumber);
                }
            });

            // Handle payment method radio changes in modal
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedPaymentMethod = e.target.value;
                });
            });
        }

        // Purchase with wallet
        async function purchaseWithWallet(phoneNumber) {
            if (!selectedPackage || !currentUser) return;

            const confirmBtn = document.querySelector('#phoneForm button[type="submit"]');
            const confirmBtnText = document.getElementById('confirmBtnText');
            const confirmBtnLoading = document.getElementById('confirmBtnLoading');

            // Check balance
            if (userBalance < selectedPackage.price) {
                notyf.error('Insufficient balance. Please fund your wallet.');
                phoneModal.hide();
                window.location.href = '/wallet';
                return;
            }

            // Show loading
            confirmBtn.disabled = true;
            confirmBtnText.textContent = 'Processing...';
            confirmBtnLoading.style.display = 'inline-block';

            try {
                // Extract volume from package name
                let volume = '1';
                if (selectedPackage.name) {
                    const volumeMatch = selectedPackage.name.match(/\d+/);
                    if (volumeMatch) {
                        volume = volumeMatch[0];
                    }
                }

                const response = await fetch('/api/purchase-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        network: selectedNetwork,
                        volume: volume,
                        phoneNumber: phoneNumber,
                        amount: selectedPackage.price,
                        packageName: selectedPackage.name
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ… Purchase successful:', result);
                    
                    // Update balance
                    userBalance = result.newBalance;
                    document.getElementById('balanceText').textContent = `â‚µ${userBalance.toFixed(2)}`;
                    
                    // Close phone modal
                    phoneModal.hide();
                    
                    // Show success modal with order details
                    showResultModal({
                        status: 'success',
                        orderId: result.orderId,
                        reference: result.reference || result.ref || result.transactionReference,
                        phoneNumber: phoneNumber,
                        packageName: selectedPackage.name,
                        packagePrice: selectedPackage.price,
                        network: selectedNetwork,
                        userPhone: currentUser && currentUser.phoneNumber ? currentUser.phoneNumber : 'Your Number'
                    });
                } else {
                    // Check if it's an out of stock error
                    const msg = result.error || (result.isOutOfStock ? 'Out of Stock - Provider has insufficient balance' : 'Purchase failed');
                    console.log('ðŸ“¦ Purchase failed:', msg);
                    showResultModal({ status: 'failed', message: msg, orderId: result.orderId });

                    // Reset button
                    confirmBtn.disabled = false;
                    confirmBtnText.textContent = 'Confirm Purchase';
                    confirmBtnLoading.style.display = 'none';
                }
            } catch (error) {
                console.error('Purchase error:', error);
                notyf.error(error.message);
                
                // Reset button
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Confirm Purchase';
                confirmBtnLoading.style.display = 'none';
            }
        }

        // Purchase with direct payment
        async function purchaseWithDirectPayment(phoneNumber) {
            if (!selectedPackage || !currentUser) return;

            const confirmBtn = document.querySelector('#phoneForm button[type="submit"]');
            const confirmBtnText = document.getElementById('confirmBtnText');
            const confirmBtnLoading = document.getElementById('confirmBtnLoading');

            // Show loading
            confirmBtn.disabled = true;
            confirmBtnText.textContent = 'Initializing Payment...';
            confirmBtnLoading.style.display = 'inline-block';

            try {
                console.log('ðŸ”„ Initializing direct payment for:', {
                    amount: selectedPackage.price,
                    phoneNumber: phoneNumber,
                    network: selectedNetwork,
                    package: selectedPackage.name
                });

                // Extract volume from package name
                let volume = '1';
                if (selectedPackage.name) {
                    const volumeMatch = selectedPackage.name.match(/\d+/);
                    if (volumeMatch) {
                        volume = volumeMatch[0];
                    }
                }

                // Initialize direct payment
                const response = await fetch('/api/initialize-direct-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: selectedPackage.price,
                        phoneNumber: phoneNumber,
                        network: selectedNetwork,
                        packageName: selectedPackage.name,
                        volume: volume
                    })
                });

                const result = await response.json();

                console.log('ðŸ’° Server response:', result);

                if (result.status && result.data && result.data.authorization_url) {
                    console.log('âœ… Redirecting to Paystack...');
                    // Redirect to Paystack
                    window.location.href = result.data.authorization_url;
                } else if (response.ok) {
                    throw new Error(result.error || result.message || 'Failed to initialize payment');
                } else {
                    throw new Error(result.error || result.message || 'Server error');
                }
            } catch (error) {
                console.error('Direct payment error:', error);

                const msg = (error && error.message && error.message.includes('Out of Stock')) ? 'Out of Stock - Data temporarily unavailable. Please try again later.' : (`Payment failed: ${error && error.message ? error.message : 'An error occurred'}`);
                showResultModal({ status: 'failed', message: msg });

                // Reset button
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Confirm Purchase';
                confirmBtnLoading.style.display = 'none';
            }
        }

        // Show result modal (success or failed) with order details
        function showResultModal(data) {
            // data: { status: 'success'|'failed', orderId, phoneNumber, packageName, packagePrice, network, userPhone, message }
            const formatPhoneDisplay = (phone) => {
                if (!phone) return 'Your Number';
                const cleanPhone = String(phone).replace(/\D/g, '');
                if (cleanPhone.length === 10) {
                    return `+233 ${cleanPhone.substring(0, 3)} ${cleanPhone.substring(3, 6)} ${cleanPhone.substring(6)}`;
                }
                return `+233 ${cleanPhone}`;
            };

            const status = data.status || (data.orderId ? 'success' : 'failed');
            const networkLabel = data.network === 'mtn' ? 'MTN' : data.network === 'at' ? 'AT' : (data.network || 'Network');

            // Update numbers and package info if present
            if (document.getElementById('successUserNumber')) document.getElementById('successUserNumber').textContent = formatPhoneDisplay(data.userPhone);
            if (document.getElementById('successReceiverNumber')) document.getElementById('successReceiverNumber').textContent = data.phoneNumber || '';
            if (document.getElementById('successPackage')) document.getElementById('successPackage').textContent = data.packageName ? `${data.packageName} - â‚µ${(data.packagePrice||0).toFixed(2)}` : (data.packageName || '');
            if (document.getElementById('successNetwork')) document.getElementById('successNetwork').textContent = `${networkLabel} Network`;
            if (document.getElementById('successOrderId')) document.getElementById('successOrderId').textContent = data.orderId ? `#${data.orderId}` : '';

            // Header / icon / subtitle
            const icon = document.getElementById('resultIcon');
            const iconWrap = document.getElementById('resultIconWrap');
            const title = document.getElementById('resultTitle');
            const subtitle = document.getElementById('resultSubtitle');
            const primaryBtn = document.getElementById('resultPrimaryBtn');

            if (status === 'success') {
                if (icon) { icon.className = 'fas fa-check'; icon.style.color = '#ffffff'; }
                if (iconWrap) { iconWrap.style.background = '#2f855a'; }
                if (title) title.textContent = 'Package Sent!';
                if (subtitle) subtitle.textContent = 'Your data is being delivered';
                if (primaryBtn) {
                    primaryBtn.textContent = '';
                    primaryBtn.innerHTML = '<i class="fas fa-home me-2"></i>Back to Home';
                    primaryBtn.onclick = () => { if (successModal) successModal.hide(); setTimeout(()=>window.location.href='/',300); };
                }
            } else {
                // failed
                if (icon) { icon.className = 'fas fa-times-circle'; icon.style.color = '#ffffff'; }
                if (iconWrap) { iconWrap.style.background = '#e53e3e'; }
                if (title) title.textContent = 'Purchase Failed';
                if (subtitle) subtitle.textContent = data.message || 'We could not process your purchase.';
                if (primaryBtn) {
                    primaryBtn.textContent = '';
                    primaryBtn.innerHTML = '<i class="fas fa-arrow-left me-2"></i>Back to Purchase';
                    primaryBtn.onclick = () => { if (successModal) successModal.hide(); setTimeout(()=>window.location.href='/purchase',300); };
                }
            }

            // expose last order id for copy
            window.currentOrderId = data.orderId || window.currentOrderId;

            // Reference (transaction reference) if provided
            if (document.getElementById('successReference')) {
                const ref = data.reference || data.ref || data.transactionReference || '';
                document.getElementById('successReference').textContent = ref || '-';
            }

            if (successModal) successModal.show();
        }

        // Copy order ID to clipboard
        function copyOrderId() {
            const orderId = document.getElementById('successOrderId').textContent;
            navigator.clipboard.writeText(orderId).then(() => {
                notyf.success('Order ID copied!');
            }).catch(() => {
                notyf.error('Failed to copy');
            });
        }

        // Go back to home
        function goToHome() {
            if (successModal) {
                successModal.hide();
            }
            setTimeout(() => {
                window.location.href = '/';
            }, 300);
        }

        // Select payment method from payment options (if needed for compatibility)
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.payment-option').classList.add('selected');
        }

        // Select payment method from modal
        function selectPaymentMethodModal(method) {
            selectedPaymentMethod = method;
            
            // Update radio button
            if (method === 'wallet') {
                document.getElementById('walletRadio').checked = true;
            } else {
                document.getElementById('directRadio').checked = true;
            }
            
            // Update UI
            document.querySelectorAll('.payment-option-modal').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
